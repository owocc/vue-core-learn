// å¯¹æ•°æ®è¿›è¡ŒåŠ«æŒ

/* Note:
    dataä¸­çš„æ•°æ®å¯èƒ½æ˜¯ä¸€ä¸ª æ™®é€šçš„å¯¹è±¡çš„å€¼:           {name:'owo'}
    ä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ä¸­çš„å¯¹è±¡:                       {user:{age:12}}
    æˆ–è€…ä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªæ™®é€šçš„æ•°ç»„ä¹Ÿå¯èƒ½æ˜¯æ•°ç»„ä¸­åµŒå¥—      {[1,2,3]} || {[{age:12},{age:14},{age:15}]}
    å½“ç„¶æ•°æ®ä¹Ÿå¯èƒ½æ›´å¤æ‚,å°±æ˜¯ä¸€è·¯åµŒå¥—è¿›å»
    è¿™é‡Œçš„æœ€å¤–å±‚çš„ {} éƒ½æ˜¯æŒ‡ data è¿”å›çš„é‚£ä¸ªå¯¹è±¡(( 
*/

export function observer(data) {
    // è¿™é‡Œè¦åˆ¤æ–­æ•°æ®æ˜¯å¦ä¸æ˜¯ object
    if (typeof data != 'object' || data == null) {
        return data
    }
    // å¤„ç†å¯¹è±¡çš„æ•°æ®åŠ«æŒ
    return new Observer(data)
}

// å¯¹æ•°æ®è¿›è¡ŒåŠ«æŒ
// Observer è§‚å¯Ÿè€…
// åœ¨ vue2 ä¸­æ˜¯ä½¿ç”¨ Object.defineProperty æ¥å¯¹æ•°æ®è¿›è¡ŒåŠ«æŒçš„,å®ƒæœ‰ä¸€ä¸ªç¼ºç‚¹å°±æ˜¯åªèƒ½å¯¹å¯¹è±¡ä¸­çš„ä¸€ä¸ªå±æ€§è¿›è¡ŒåŠ«æŒ(æ‰€ä»¥éœ€è¦ä½¿ç”¨é€’å½’æ¥è¿›è¡Œæ•°æ®çš„åŠ«æŒ)
class Observer {
    constructor(value) {
        this.walk(value)
    }
    walk(data) {
        let keys = Object.keys(data) // è·å–åˆ°å¯¹è±¡çš„æ‰€æœ‰ key,æ–¹ä¾¿ç­‰ä¸‹ç”¨ Object.defineProperty æ¥è®¾ç½®ä»£ç†
        // é€šè¿‡å¾ªç¯è®¾ç½®æ•°æ®åŠ«æŒ 
        for (let i = 0; i < keys.length; i++) {
            let key = keys[i] // å¾—åˆ°å¯¹è±¡ä¸­çš„ä¸€ä¸ªé”®
            let value = data[key] // value è¡¨ç¤ºä¼ å…¥çš„ data å¯¹è±¡å¯¹åº”çš„å€¼(å’Œkeyå¯¹åº”)
            defineReactive(data,key,value)
        }
    }
}
/**
 * å¯¹å¯¹è±¡ä¸­çš„å±æ€§è¿›è¡ŒåŠ«æŒ
 * @param {*} data éœ€è¦è¿›è¡Œæ•°æ®åŠ«æŒçš„å¯¹è±¡
 * @param {*} key éœ€è¦åŠ«æŒçš„é”®
 * @param {*} value æ•°æ®çš„å€¼
 */
function defineReactive(data,key,value){
    // åœ¨è¿™ä¸ªåœ°æ–¹å°±è¦è¿›è¡Œé€’é¾ŸğŸ¢,ä¸ºäº†è®©æ›´æ·±å±‚çš„æ•°æ®ä¹Ÿè¢«ä»£ç†
    // å› ä¸ºåœ¨è¿™é‡Œçš„æ—¶å€™æ•°æ®å¯èƒ½é•¿è¿™æ ·: dataæ•°æ®:{user:{age:1,sex:{man:1,woman:1}}}
    observer(value) // å¯¹æ•°æ®è¿›è¡Œæ·±åº¦ç›‘å¬((æ•°æ®ç‰¹åˆ«å¤šçš„è¯,å†…å­˜è¡¨ç¤ºä½ è¡Œ,ç»™ä½ å¤§æ‹‡å“¥ğŸ‘
    Object.defineProperty(data,key,{
        get(){
            console.log('è·å–',key);
            return value
        },
        //set æ–¹æ³•æ¥æ”¶åˆ°çš„å°±æ˜¯æ–°è®¾ç½®çš„å€¼
        set(newValue){
            // åˆ¤æ–­æ–°è®¾ç½®çš„å€¼æ˜¯å¦å’Œå½“å‰çš„å€¼ä¸€è‡´,å¦‚æœä¸€è‡´ç›´æ¥è¿”å›
            if(newValue === value) return
            // å¦‚æœä¸ä¸€è‡´,å°±æ›´æ–°
            // ä¸è¿‡åœ¨ä¿®æ”¹å‰ä¹Ÿå¾—ä¸ºæ•°æ®è®¾ç½®ä¸€ä¸‹å“åº”å¼~å› ä¸ºä¼ å…¥çš„å€¼å¯èƒ½æ˜¯ä¸€ä¸ªæ–°çš„å¯¹è±¡
            observer(newValue)
            value = newValue
        }
    })
}